# 6.2. N+1 и ленивые загрузки

## Результат
- **Статус:** ⚠️ Требует проверки
- **Severity:** S2
- **Краткое заключение:** отсутствует мониторинг N+1; в коде активно используются ленивые обращения к связям.

## Наблюдение
- Не включён `Model::preventLazyLoading()` для production.
- Листы товаров и заказов используют `->get()` с последующей итерацией по связям, что потенциально вызывает N+1 (см. `ProductService::getList`, `Lead`/`Order`).
- Нет трасс из Telescope/Clockwork для подтверждения либо опровержения проблемы.

## Доказательства
- `app/Services/ProductService.php:545-608`
- `app/Models/Lead` и связанные вызовы в `Job::afterWidgetAddAndDeleteProducts`

## Риски
- Медленная работа UI (страницы >10 секунд), высокая нагрузка на БД.
- Увеличение стоимости хостинга и нестабильность под нагрузкой.

## Рекомендации
1. Включить `Model::preventLazyLoading()` в production и обработать исключения.
2. Использовать `with()` / `withCount()` / `select()` для явной загрузки связанных данных.
3. Добавить профилирование страниц через Telescope/Clockwork и собрать список медленных запросов.

## Следующие шаги
- 🟨 Ответственный: Backend
- ⏱ Срок: 2 недели (после стабилизации критических проблем)
- 📌 Контроль: автоматически падающие тесты при N+1 (использовать пакет `beyondcode/laravel-query-detector`).
