# Чеклист аудита Laravel-приложения

## 0. Методика и шкала оценки

### 0.1. Шкала серьезности (Severity)

- **S0** — критично: безопасность/утечки, потеря данных, недоступность продакшна
- **S1** — очень важно: риск простоев/коррупции данных/финансовых потерь
- **S2** — важно: ощутимые деградации производительности/устойчивости
- **S3** — желательно: техдолг, ухудшает поддержку/скорость разработки

### 0.2. Формат фиксации находок (для каждого пункта)

- **Наблюдение**: кратко
- **Доказательства**: файлы/команды/скрины логов/коммиты
- **Риск (Severity)**: S0–S3
- **Почему это плохо**: 1–3 предложения
- **Рекомендация**: конкретное действие
- **Срок**: немедленно/1–2 недели/до релиза X
- **Владелец**: роль/имя

### 0.3. Быстрые инструменты

#### Команды
```bash
php artisan about
php artisan route:list
php artisan migrate:status
php artisan config:cache
php artisan view:cache
php artisan tinker
php -v
composer outdated
```

#### Линтеры/анализ
- PHPStan/Larastan
- PHPCS
- PHP-CS-Fixer (dry-run)
- Psalm

#### Загрузка страниц/профилирование
- Laravel Telescope (только dev/stage)
- Clockwork
- Blackfire/Xdebug (локально)

#### БД
- `EXPLAIN`
- `SHOW INDEXES`
- pt-query-digest (если есть логи медленных запросов)

#### Безопасность
- Trivy/Grype (образы)
- Composer Audit (`composer audit`)
- Secret scanners (gitleaks/trufflehog)

---

## 1. Общая информация и воспроизводимость

### 1.1. Версии и воспроизводимость сборки

**Проверить**: PHP, Laravel, Composer, OS/контейнеры зафиксированы в README/composer.json/Dockerfile

**Ожидаемое «хорошо»**: есть `composer.lock`, версии пиннуты, локально поднимается по инструкции

**Красные флаги**:
- нет `composer.lock`
- сборка зависит от глобальных расширений
- несовместимости по PHP

**Рекомендация**: зафиксировать версии, добавить Makefile/скрипт bootstrap

### 1.2. Лицензии и правовые риски

**Проверить**: лицензии пакетов через `composer licenses`

**Хорошо**: нет GPL-несовместимостей при закрытой разработке

**Плохо**: пакеты с ограничивающими лицензиями без согласования

**Рекомендация**: заменить/исключить, добавить политику выбора пакетов

---

## 2. Конфигурации и секреты

### 2.1. Хранение секретов

**Проверить**: `.env` не в git; нет ключей/паролей в коде/конфигах

**Хорошо**: секреты только в `.env`/Vault/Secrets Manager; ротация ключей

**Плохо**: ключи в репозитории, секреты в `config/*.php`

**Рекомендация**: удалить из истории (BFG/git filter-repo), внедрить хранилище секретов, маскирование

### 2.2. Режимы окружений

**Проверить**: `APP_DEBUG=false` на prod; разные `.env`/сервисы для dev/stage/prod

**Хорошо**: четкое разделение, разные БД/очереди/кэши

**Плохо**: единый Redis/БД для всех окружений; `APP_ENV=local` на prod

**Рекомендация**: разделить инфраструктуру, включить конфиг-кэш в деплое

---

## 3. Зависимости и безопасность

### 3.1. Устаревшие/уязвимые пакеты

**Проверить**: `composer outdated`, `composer audit`

**Хорошо**: обновления до поддерживаемых версий, LTS Laravel

**Плохо**: end-of-life PHP/Laravel; известные CVE

**Рекомендация**: план обновлений, PoC тесты регрессий

### 3.2. Избыточные пакеты

**Проверить**: назначение каждого пакета, бандл-размер

**Плохо**: тяжёлые пакеты ради одной функции, дублирующие зависимости

**Рекомендация**: удалить/заменить на встроенные средства

---

## 4. Архитектура и слои приложения

### 4.1. Границы слоёв

**Проверить**: контроллеры тонкие, бизнес-логика вынесена в сервисы/Actions/UseCases; доступ к данным через репозитории/квери-объекты (по необходимости)

**Хорошо**: ясные зависимости, тестируемые юниты

**Плохо**: «толстые» контроллеры/модели, статика/синглтоны повсюду

**Рекомендация**: рефакторинг по кейсам, разрезание модулей

### 4.2. Доменные модели и DTO/VO

**Проверить**: наличие DTO/ValueObject вместо «сырых массивов»

**Плохо**: разнородные структуры в массивах, магические ключи

**Рекомендация**: ввести явные типы, мапперы

---

## 5. Маршруты, middleware, доступы

### 5.1. Организация маршрутов

**Проверить**: `route:list` на группировки, префиксы, версии API

**Хорошо**: `/api/v1/*`, middleware по слоям (auth, throttle)

**Плохо**: публичные опасные маршруты, неявные `Route::any`

**Рекомендация**: закрыть лишнее, ограничить методы, добавить rate-limit

### 5.2. Авторизация и политики

**Проверить**: Policies/Gates, проверка прав на операции с моделями

**Плохо**: проверки прав в шаблонах/фронте вместо бэка

**Рекомендация**: внедрить политики, централизовать проверки

---

## 6. Модели Eloquent и данные

### 6.1. Массовые присвоения

**Проверить**: `$fillable`/`$guarded`

**Плохо**: открытые модели (`$guarded = []`) без валидации

**Рекомендация**: явные `$fillable`, запрет «массовых дыр»

### 6.2. N+1 и ленивые загрузки

**Проверить**: Telescope/Clockwork, запрет ленивой загрузки в prod (`preventLazyLoading()`)

**Плохо**: N+1 в списках, «взрыв» запросов

**Рекомендация**: `with()`, `withCount()`, выборочные поля

### 6.3. Касты и атрибуты

**Проверить**: `$casts` (decimal, json, datetime), mutators/accessors

**Плохо**: хранение денег в float, JSON-строки без валидации

**Рекомендация**: `decimal(…)`/Money VO, строгие касты

---

## 7. База данных и миграции

### 7.1. Схема и ограничения

**Проверить**: внешние ключи, уникальные индексы, not null

**Плохо**: «мягкие» связи на доверии, отсутствие индексов по фильтрам

**Рекомендация**: добавить индексы по where/order, ввести FK/unique

### 7.2. Качество миграций

**Проверить**: обратимость, отсутствие бизнес-логики, батч-миграции

**Плохо**: тяжелые операции на prod без блокировок/окон обслуживания

**Рекомендация**: `--step`, онлайновые техники (перенос/копия/rename)

### 7.3. Производительность SQL

**Проверить**: slow-query-log, `EXPLAIN`, кардинальность индексов

**Плохо**: `SELECT *`, сортировки/фильтры по неиндексируемым колонкам

**Рекомендация**: покрывающие индексы, денормализации точечно

---

## 8. Входные данные, валидация и ошибки

### 8.1. FormRequest/Rules

**Проверить**: все публичные эндпоинты защищены валидацией

**Плохо**: валидация в контроллере/модели, отсутствие сообщений локали

**Рекомендация**: вынести в FormRequest, единый формат ошибок

### 8.2. Обработка исключений

**Проверить**: `App\Exceptions\Handler`, маппинг доменных ошибок на HTTP коды

**Плохо**: 500 там, где ожидаем 4xx/422; проглатывание исключений

**Рекомендация**: явная типизация исключений, аудит логирования

---

## 9. Логирование и наблюдаемость

### 9.1. Логи приложения

**Проверить**: каналы Monolog, JSON-формат, ротация, корреляция request-id

**Плохо**: лог-шум, PII, секреты в логах

**Рекомендация**: маскирование, отдельные каналы интеграций

### 9.2. Ошибки и алерты

**Проверить**: Sentry/Bugsnag/Flare, релизы, source-maps

**Плохо**: отсутствие алертов/градации уровней

**Рекомендация**: уведомления по S0/S1 в мессенджер/почту, он-колл

### 9.3. Метрики и профили

**Проверить**: P50/P95/P99, RPS, ошибки, состояние очередей

**Плохо**: нет метрик, реактивное тушение пожаров

**Рекомендация**: прометеевские метрики, дашборды

---

## 10. Очереди, планировщик, фоновые задачи

### 10.1. Очереди

**Проверить**: драйвер (Redis/Rabbit), Horizon, retry/backoff, идемпотентность

**Плохо**: cron вместо очередей, повторная обработка без защиты

**Рекомендация**: идемпотентные ключи, dead-letter, мониторинг

### 10.2. Планировщик

**Проверить**: `Console/Kernel.php`, `schedule:run` в кроне/systemd timer

**Плохо**: ручной запуск, гонки

**Рекомендация**: лок/mutex, health-checks

---

## 11. Кэширование и производительность

### 11.1. Кэш-стратегии

**Проверить**: `Cache::remember`, теги, TTL, инвалидация по событиям

**Плохо**: бессрочные кэши, устаревающие данные без инвалидации

**Рекомендация**: кэш-политика, чёткие зоны ответственности

### 11.2. Оптимизация фреймворка

**Проверить**: `config:cache`, `route:cache`, `view:cache`, OPCache/JIT

**Плохо**: кэш не включается из-за динамики/замыканий в маршрутах

**Рекомендация**: исправить замыкания, прогрев кэшей в деплое

### 11.3. Пагинация/списки

**Проверить**: `paginate`/`cursorPaginate`, фильтры/сортировки сервер-сайд

**Плохо**: выгрузка тысяч строк за раз

**Рекомендация**: курсорная пагинация, ограничение страниц

---

## 12. Контракты API и защита

### 12.1. Версионирование и спецификация

**Проверить**: `/api/v1`, OpenAPI/Swagger, пример ответов/ошибок

**Плохо**: ломающие изменения без версий, отсутствие схемы

**Рекомендация**: генерируемая спецификация, контракт-тесты

### 12.2. Аутентификация/авторизация API

**Проверить**: Sanctum/Passport/JWT, TTL, scopes/abilities

**Плохо**: бессрочные токены, отсутствие scope-контроля

**Рекомендация**: ограничить права/сроки, ротация токенов

### 12.3. Защита интерфейсов

**Проверить**: rate-limit, anti-replay, подписи вебхуков, CSRF, CORS

**Плохо**: открытые вебхуки, универсальные CORS `*`

**Рекомендация**: сигнатуры, строгий CORS, лимитирование

---

## 13. Безопасность приложения и данных

### 13.1. Политики доступа

**Проверить**: Policies, разделение ролей, запрещённые действия

**Плохо**: доверие фронту, проверка прав после факта

**Рекомендация**: принудительная проверка на сервере

### 13.2. Хранение и передача данных

**Проверить**: HTTPS, HSTS, secure cookies, SameSite, шифрование at-rest

**Плохо**: HTTP на prod, общие куки, открытые бакеты

**Рекомендация**: принудительный TLS, закрыть бакеты

### 13.3. Загрузка файлов

**Проверить**: MIME/размер, приватные диски, временные ссылки

**Плохо**: хранение пользовательских файлов в `public/` без проверки

**Рекомендация**: Storage+S3, вирус-скан при необходимости

---

## 14. Файловые хранилища и CDN

### 14.1. Конфигурация дисков

**Проверить**: `filesystems.php`, разделение приват/публич

**Плохо**: всё на локальном диске prod-сервера

**Рекомендация**: S3/MinIO, CDN для статики

---

## 15. Почта и уведомления

### 15.1. Доставка

**Проверить**: драйверы (SES/Mailgun/SMTP), очереди для отправки

**Плохо**: синхронная отправка, блокирующие письма

**Рекомендация**: вынести в очередь, добавить retry/policy

### 15.2. Безопасность писем

**Проверить**: DKIM/SPF/DMARC (на уровне домена)

**Плохо**: спам/блокировки

**Рекомендация**: настроить записи, мониторить доставляемость

---

## 16. Локализация, время, валюты

### 16.1. Локали

**Проверить**: `lang/*`, отсутствие «зашитых» строк

**Плохо**: русско-английская смесь в коде

**Рекомендация**: вынести строки в словари

### 16.2. Время и TZ

**Проверить**: хранение в UTC, конвертация на краю

**Плохо**: локальные TZ в БД

**Рекомендация**: единые правила времени

---

## 17. Тестирование и качество

### 17.1. Наличие и покрытие тестов

**Проверить**: unit/feature, критические сценарии (аутентификация, платежи, заказы)

**Плохо**: «пустая» папка `tests`, flaky-тесты

**Рекомендация**: минимальный набор крит-тестов, стабилизация

### 17.2. Статический анализ

**Проверить**: PHPStan/Larastan lvl ≥ 6, нулевые регрессии в CI

**Плохо**: выключен анализ/море предупреждений

**Рекомендация**: повысить уровень, фиксить по очереди

---

## 18. Интеграции и внешние сервисы

### 18.1. Клиенты интеграций

**Проверить**: сервис-клиенты, таймауты, retry, circuit breaker

**Плохо**: без таймаутов, бесконечные ретраи, блокировки воркеров

**Рекомендация**: экспоненциальный backoff, fuse/circuit

### 18.2. Вебхуки и идемпотентность

**Проверить**: проверка подписей, дедупликация, повторяемость обработки

**Плохо**: двойные операции (списания/заказы)

**Рекомендация**: идемпотентные ключи, таблица событий

---

## 19. DevOps, деплой, окружения

### 19.1. CI/CD

**Проверить**: пайплайн — линтеры, тесты, сборка, миграции, кеш-оптимизация

**Плохо**: деплой руками по SSH, без миграций/отката

**Рекомендация**: Zero-downtime деплой, артефакты

### 19.2. Инфраструктура

**Проверить**: разделение ролей (web/queue/db/cache), резервирование

**Плохо**: всё на одном сервере, нет мониторинга

**Рекомендация**: разнести сервисы, ввести мониторинг/алерты

### 19.3. Бэкапы и восстановление

**Проверить**: расписание бэкапов, тест восстановления, ротация 7/30/90

**Плохо**: бэкапы «вручную», не проверяются

**Рекомендация**: автоматизация + регулярный DR-дрилам

---

## 20. Документация и операционные процедуры

### 20.1. Проектная документация

**Проверить**: README (установка, запуск), `.env.example`, Makefile/скрипты

**Плохо**: знания «в головах»

**Рекомендация**: оформить быстрый старт

### 20.2. Runbooks и API-доки

**Проверить**: деплой-гайд, откат, миграции, аварийные процедуры; OpenAPI/Swagger

**Плохо**: отсутствие регламентов, Postman-хаос

**Рекомендация**: стандартизовать коллекции и environments

---

## 21. Профилирование перформанса (минимальный срез)

### 21.1. Целевые метрики

- **API**: P95 < 800 мс; страницы списков < 2–3 с с пагинацией
- **Очереди**: успех > 99%, нет «залипших» джоб
- **БД**: медленных запросов < 1% от общего

### 21.2. Как проверить

1. Снять трассы 5–10 горячих сценариев (топ-эндпоинты)
2. Снять top N медленных SQL, построить план индексации

---

## 22. Итоговая сводка аудита (шаблон)

### 22.1. Одностраничное резюме

- **Текущее состояние**: кратко
- **Топ-5 рисков (S0/S1)**
- **Быстрые победы (Quick Wins)** на 1–2 недели

### 22.2. Таблица проблем (пример)

| Блок | Описание | Доказательства | Severity | Рекомендация | Срок | Владелец |
|------|----------|----------------|----------|--------------|------|----------|
| ...  | ...      | ...            | ...      | ...          | ...  | ...      |

### 22.3. Дорожная карта

- **Стабилизация (0–2 недели)**: инциденты, индексы, очереди, Sentry
- **Оптимизация (2–6 недель)**: кэш-слои, рефакторинг крит-путей
- **Масштабирование (6+ недель)**: разнос сервисов, HA, обновления стеков

---

## 23. Приложения (шаблоны и команды)

### 23.1. Быстрые команды проверки

```bash
# Общая сводка
php artisan about

# Маршруты
php artisan route:list

# Кешируемость
php artisan config:cache && php artisan route:cache && php artisan view:cache

# Миграции
php artisan migrate:status

# Horizon
php artisan horizon:status

# Пакеты/уязвимости
composer outdated
composer audit

# PHP модули
php -m

# Индексы
SHOW INDEX FROM <table>

# План запроса
EXPLAIN <sql>
```

### 23.2. Критерии «пройдено/не пройдено» по блокам

Блок считается пройденным только если:

- соблюдены все обязательные пункты блока
- нет S0/S1 находок
- есть доказательства (коммиты/скриншоты/вывод команд)

**Любая S0/S1-находка переводит блок в статус «не пройден».**

---

## 24. Строгие красные флаги (немедленное исправление)

- [ ] Секреты в репозитории, `APP_DEBUG=true` на prod
- [ ] Отсутствие бэкапов/проверок восстановления
- [ ] Нет очередей при тяжёлых задачах/интеграциях
- [ ] Устаревшие небезопасные версии PHP/Laravel
- [ ] Нет ограничений БД (FK/unique), массовые N+1, медленные списки
- [ ] Отсутствие мониторинга/алертов по 5xx/ошибкам очередей
- [ ] Публичные незакрытые эндпоинты, вебхуки без подписи

---

## Примечание

Этот чеклист рассчитан на полноценную, всестороннюю оценку. Используйте блоки как независимые секции аудита: проходите слева направо, фиксируйте всё документально. Если пункт сомнителен — трактуем как проблему (и это попадёт в отчёт).

Если нужно, подготовлю версию в `.md`/`.docx` с чекбоксами и пустыми полями под «Доказательства/Рекомендация/Срок/Владелец», а также шаблон итогового отчёта.

